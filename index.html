<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Lunch Menu</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, rgba(10, 132, 255, 0.1), rgba(48, 209, 88, 0.1));
      min-height: 100vh;
      padding: 20px;
      color: #222;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      padding: 20px;
      background: linear-gradient(135deg, rgba(10, 132, 255, 0.1), rgba(48, 209, 88, 0.1));
      border-bottom: 1px solid #eee;
      text-align: center;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
      color: #666;
      margin-bottom: 10px;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #ddd;
      border-radius: 50%;
      border-top-color: #0a84ff;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      padding: 20px;
      background: #fee;
      color: #c33;
      border-radius: 8px;
      margin: 20px;
    }

    .error strong {
      display: block;
      margin-bottom: 8px;
    }

    .menu-content {
      padding: 20px;
    }

    .day-section {
      margin-bottom: 24px;
      border-bottom: 1px solid #eee;
      padding-bottom: 16px;
    }

    .day-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .day-header {
      font-weight: 600;
      font-size: 16px;
      color: #111;
      margin-bottom: 8px;
    }

    .day-date {
      font-size: 12px;
      color: #999;
      margin-bottom: 12px;
    }

    .menu-items {
      list-style: none;
    }

    .menu-item {
      padding: 8px 0;
      padding-left: 20px;
      position: relative;
      color: #222;
      font-size: 14px;
      line-height: 1.4;
    }

    .menu-item::before {
      content: "â€¢";
      position: absolute;
      left: 0;
      font-weight: bold;
    }

    .no-items {
      color: #999;
      font-size: 14px;
      padding: 8px 0;
      font-style: italic;
    }

    .more-items {
      color: #0a84ff;
      font-size: 13px;
      padding-top: 8px;
      font-weight: 500;
    }

    .footer {
      padding: 16px 20px;
      background: #f9f9f9;
      border-top: 1px solid #eee;
      font-size: 12px;
      color: #999;
      text-align: center;
    }

    .footer a {
      color: #0a84ff;
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background: #111;
        color: #eae;
      }

      .container {
        background: #1a1a1a;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      }

      .header {
        background: linear-gradient(135deg, rgba(10, 132, 255, 0.2), rgba(48, 209, 88, 0.2));
        border-bottom-color: #333;
      }

      .header h1 {
        color: #aaa;
      }

      .day-section {
        border-bottom-color: #333;
      }

      .day-header {
        color: #fff;
      }

      .day-date {
        color: #666;
      }

      .menu-item {
        color: #eae;
      }

      .no-items {
        color: #666;
      }

      .error {
        background: #3a2020;
        color: #f99;
      }

      .footer {
        background: #0f0f0f;
        border-top-color: #333;
        color: #666;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ½ï¸ Lunch â€¢ Next 5 School Days</h1>
    </div>
    <div id="content">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading menu...</p>
      </div>
    </div>
    <div class="footer">
      Data from <a href="https://www.linqconnect.com/" target="_blank">LINQConnect</a>
    </div>
  </div>

  <script>
    // â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const CONFIG = {
      buildingId: "d76afdbb-caa8-ed11-8e6a-c150c5c7a01a",
      districtId: "9fd1237e-53a6-ed11-8e69-985645bc2745",
      mealSession: "Lunch",
      daysToShow: 5,
      skipWeekends: true,
      maxItemsPerDay: 999,  // show all for web
      bullet: "â€¢",
      exclude: [
        // "Milk", "Chocolate Milk", "Assorted Fruit", "Ketchup", "Mustard", "Mayo"
      ],
      ignorePatterns: [
        "PBJ","corndog","Yogurt","Chicken Shawarma WG","Tikka","soup"
      ]
    };

    // â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function fmtAPI(d) {
      return `${d.getMonth() + 1}-${d.getDate()}-${d.getFullYear()}`;
    }

    function ymd(d) {
      const mm = (d.getMonth() + 1).toString().padStart(2, "0");
      const dd = d.getDate().toString().padStart(2, "0");
      return `${d.getFullYear()}-${mm}-${dd}`;
    }

    function niceDate(d) {
      return new Intl.DateTimeFormat("en-US", {
        weekday: "short",
        month: "short",
        day: "numeric"
      }).format(d);
    }

    function isWeekend(d) {
      const w = d.getDay();
      return w === 0 || w === 6;
    }

    function nextSchoolDays(n, skipWeekends = true) {
      const out = [];
      let d = new Date();
      while (out.length < n) {
        if (!(skipWeekends && isWeekend(d))) out.push(new Date(d));
        d.setDate(d.getDate() + 1);
      }
      return out;
    }

    function uniq(arr) {
      return [...new Set(arr)];
    }

    function lowerSet(arr) {
      return new Set(arr.map(s => s.toLowerCase()));
    }

    // â”€â”€ Fetch from LINQConnect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchRange(start, end) {
      const base = "https://api.linqconnect.com/api/FamilyMenu";
      const url = `${base}?buildingId=${encodeURIComponent(
        CONFIG.buildingId
      )}&districtId=${encodeURIComponent(
        CONFIG.districtId
      )}&startDate=${encodeURIComponent(fmtAPI(start))}&endDate=${encodeURIComponent(
        fmtAPI(end)
      )}`;

      const response = await fetch(url, {
        method: "GET",
        headers: { "Accept": "application/json" }
      });

      if (!response.ok) {
        throw new Error(`API request failed: ${response.status} ${response.statusText}`);
      }

      return response.json();
    }

    // â”€â”€ Extract from JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function extractFromJSON(data, mealSession, wantedDates) {
      const out = new Map();
      const sessions = data?.FamilyMenuSessions || [];
      for (const session of sessions) {
        const serving = (session?.ServingSession || "").toLowerCase();
        const planNames = (session?.MenuPlans || []).map((p) =>
          (p?.MenuPlanName || "").toLowerCase()
        );
        const lowerMeal = mealSession.toLowerCase();

        const mealOk =
          serving === lowerMeal || planNames.some((n) => n.includes(lowerMeal));
        if (!mealOk) continue;

        for (const plan of session.MenuPlans || []) {
          for (const day of plan.Days || []) {
            let dtxt = day?.Date || day?.ServiceDate || day?.MenuDate || "";
            if (!dtxt) continue;

            const d = new Date(dtxt);
            const key = ymd(d);
            if (!wantedDates.has(key)) continue;

            for (const meal of day.MenuMeals || []) {
              for (const cat of meal.RecipeCategories || []) {
                const catName = (
                  cat?.RecipeCategoryName ||
                  cat?.CategoryName ||
                  cat?.Name ||
                  cat?.DisplayName ||
                  ""
                )
                  .toString()
                  .toLowerCase();

                if (!catName.includes("main entree")) continue;

                for (const rec of cat.Recipes || []) {
                  const name =
                    rec?.RecipeName ||
                    rec?.DisplayName ||
                    rec?.ItemName ||
                    rec?.Name;
                  if (name) {
                    if (!out.has(key)) out.set(key, []);
                    out.get(key).push(name.trim());
                  }
                }
              }
            }
          }
        }
      }
      return out;
    }

    // â”€â”€ Render menu to HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderMenu(days, byDate) {
      const excl = lowerSet(CONFIG.exclude);
      const ignorePatterns = (CONFIG.ignorePatterns || []).map((p) =>
        p.toLowerCase()
      );

      let html = '<div class="menu-content">';

      for (const d of days) {
        const key = ymd(d);
        const pretty = niceDate(d);
        const items = byDate.get(key) || [];

        const list = uniq(items.map((s) => s.trim()));
        const filtered = list.filter((s) => {
          const low = s.toLowerCase();
          if (excl.has(low)) return false;
          for (const pat of ignorePatterns) {
            if (low.includes(pat)) return false;
          }
          return true;
        });

        html += `<div class="day-section">`;
        html += `<div class="day-header">${pretty}</div>`;
        html += `<div class="day-date">${key}</div>`;

        if (!filtered.length) {
          html += `<div class="no-items">(no lunch items)</div>`;
        } else {
          html += `<ul class="menu-items">`;
          for (const name of filtered) {
            html += `<li class="menu-item">${escapeHtml(name)}</li>`;
          }
          html += `</ul>`;
        }

        html += `</div>`;
      }

      html += "</div>";
      return html;
    }

    function escapeHtml(text) {
      const map = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      };
      return text.replace(/[&<>"']/g, (m) => map[m]);
    }

    // â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function main() {
      try {
        const days = nextSchoolDays(CONFIG.daysToShow, CONFIG.skipWeekends);
        const start = days[0];
        const end = days[days.length - 1];
        const wanted = new Set(days.map(ymd));

        const json = await fetchRange(start, end);
        const byDate = extractFromJSON(json, CONFIG.mealSession, wanted);

        const html = renderMenu(days, byDate);
        document.getElementById("content").innerHTML = html;
      } catch (err) {
        const errorHtml = `
          <div class="error">
            <strong>Error loading menu</strong>
            ${escapeHtml(err.message)}
          </div>
        `;
        document.getElementById("content").innerHTML = errorHtml;
        console.error("Menu loading error:", err);
      }
    }

    // â”€â”€ Run on page load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", main);
    } else {
      main();
    }
  </script>
</body>
</html>
